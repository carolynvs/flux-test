# Try Porter Operator with Flux

1. Make sure that you are connected to a Kubernetes cluster.

1. Install the Porter Operator. You will need Azure service principal
   credentials, an Azure storage connection string and your kubeconfig.
    ```bash
    porter explain -r ghcr.io/getporter/porter-operator:canary
    porter credentials generate porterops -r ghcr.io/getporter/porter-operator:canary
    porter install porterops -c porterops -r ghcr.io/getporter/porter-operator:canary
    ```

1. [Create a GitHub personal access token](https://github.com/settings/tokens)
   that has repo access.

1. Run the following bash commands:
    ```bash
    export GITHUB_TOKEN=YOUR TOKEN
    export GITHUB_USER=YOUR GITHUB USERNAME
    ```

1. Fork this repository by clicking "Use this template" on the main GitHub page.

1. Clone your fork:

    ```bash
    git clone https://github.com/YOURNAME/porterops-flux-demo.git
    cd porterops-flux-demo
    ```

1. Modify the files in ./demo replacing YOURNAME with a CNAB compatible
   registry, such as Docker Hub or GitHub Container Registry. Push your changes back up to your fork.
   ```
   git commit -am "Use my docker registry"
   git push
   ```

1. Let's look at the initial files in your fork. We can ignore the flux-system files for now, they are generated by flux. In the demo directory we have:

    **demo/bundle-repository.yaml**

    Defines an OCI repository, in our case the location of a published bundle,
    that Flux should watch for new tags.

    ```yaml
    apiVersion: image.toolkit.fluxcd.io/v1alpha1
    kind: ImageRepository
    metadata:
        name: porter-hello
        namespace: demo
    spec:
        image: YOURNAME/porter-hello
        interval: 1m0s
    ```

    **demo/bundle-policy.yaml**

    Specifies a semver range of bundle versions we want to automatically deploy.
    For example we can say that we only want 2.x to stay on v2 of the bundle but
    don't upgrade to v3. In this case we want any v0 version of the porter-hello bundle.

    ```yaml
    apiVersion: image.toolkit.fluxcd.io/v1alpha1
    kind: ImagePolicy
    metadata:
        name: 
        namespace: demo
    spec:
        imageRepositoryRef:
            name: porter-hello
        policy:
            semver:
            range: 0.x
    ```

    **demo/porter-installation.yaml**

    Defines an installation of the bundle using the Porter Operator installation CRD.
    The Porter Operator converts these into porter cli calls.

    ```yaml
    apiVersion: porter.sh/v1
    kind: Installation
    metadata:
        name: porter-hello
        namespace: demo
        annotations:
            retry: "0"
    spec:
        reference: "YOURNAME/porter-hello:v0.1.0"
        action: "install"
    ```

1. Copy the porter-hello bundle to your registry, first ensuring that you are
   logged into that registry with `docker login REGISTRY`. You will use this bundle to try out bumping the bundle version and watching Flux trigger porter runs.

    ```bash
    porter copy --source ghcr.io/getporter/porter-hello:v0.1.1 --destination YOURNAME
    ```

1. Install the [Flux CLI](https://toolkit.fluxcd.io/guides/installation/) and
   verify that your cluster is ready to use Flux:
    ```bash
    flux check --pre
    ```

1. Connect your GitHub repository to your cluster. Flux uses the GITHUB_TOKEN
   and GITHUB_USERNAME environment variables to provision a deploy key to the
   repository. This allows Flux to update the files in that repo when new
   versions of a bundle are available.
    ```bash
    flux bootstrap github \
    --components-extra=image-reflector-controller,image-automation-controller \
    --owner=YOURNAME --repository=porter-ops-flux-demo \
    --private=false --personal=true
    ```

    Flux is now watching your copy of the porter-hello bundle for new versions that match the policy in demo/bundle-policy.yaml. When new versions of the bundle are available, it will update ./demo/porter-installation.yaml with the new version and commit it to your fork
    
    When Flux reapplies all manifests in the fork, the installation CRD on your cluster is updated, triggering a new run of Porter.

1. Wait until you see the porter installation complete. One pod is named porter-hello-* where Porter runs, and then another pod is created named install-porter-hello-* where the invocation image runs. Wait for both to complete.
    ```bash
    kubectl get pods -n demo --watch
    ```

    In this demo Flux is configured to poll for changes every 10 seconds. So it could take a bit.

1. If your local porter configuration file is pointing to the same azure storage account as what you configured for the Porter Operator when you installed the bundle, then you can use the porter CLI to view the installation:

    ```bash
    porter show porterops-flux-demo
    ```

1. The next step is to turn on automatic updates for our bundle. Edit **demo/porter-installation.yaml** and add the following comment to the line where `reference` is set

    ```yaml
    reference: "YOURNAME/porter-hello:v0.1.0" # {"$imagepolicy": "demo:porter-hello"}
    ```

    The final file should look like this:

    ```yaml
    apiVersion: porter.sh/v1
    kind: Installation
    metadata:
        name: porterops-flux-demo
        namespace: demo
        annotations:
            retry: "0"
    spec:
        reference: "YOURNAME/porter-hello:v0.1.0" # {"$imagepolicy": "demo:porter-hello"}
        action: "install"
    ```

    Combined with **demo/bundle-automation.yaml** Flux will now automatically update **demo/porter-installation.yaml** with new bundle versions.

1. We can trigger a new Porter run by publishing a new version of the
   porter-hello bundle to your registry.
    ```bash
    porter copy --source ghcr.io/getporter/porter-hello:v0.1.1 --destination YOURNAME/porter-hello:v0.1.4
    ```

1. Watch and wait for the bundle to upgrade to the newer version.
    ```bash
    kubectl get pods -n demo --watch
    ```

    In this demo Flux is configured to poll for changes every 10 seconds. So it could take a bit.

Eventually you should see another run of Porter complete.

That's it! You now know how to integrate Flux and the Porter Operator.
